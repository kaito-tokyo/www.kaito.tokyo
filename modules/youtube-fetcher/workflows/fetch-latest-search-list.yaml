- SetConstants:
    assign:
      - channelId: '${sys.get_env("CHANNEL_ID")}'
      - cacheBucketName: '${sys.get_env("CACHE_BUCKET_NAME")}'
      - metadataBucketName: '${sys.get_env("METADATA_BUCKET_NAME")}'
      - today: '${text.split(time.format(sys.now()), "T")[0]}'
      - cachedObjectName: '${channelId + "/youtube-list-search/" + today + ".json"}'
- GetSearchList:
    call: "http.get"
    args:
      url: "https://asia-east1-www-kaito-tokyo.cloudfunctions.net/youtube-list-search"
      query:
        channelId: "${channelId}"
        outputBucket: "${cacheBucketName}"
        outputObject: "${cachedObjectName}"
      auth:
        type: "OIDC"
- IterateForAllSearchItems:
    for:
      value: "item"
      in: "${searchList.body.items}"
      steps:
        - AssignMetadataObjectName:
            assign:
              - metadataObjectName: '${channelId + "/search/" + item.snippet.publishedAt + " " + item.id.videoId + ".json"}'
        - SaveSearchItem:
            call: "googleapis.storage.v1.objects.insert"
            args:
              bucket: "${metadataBucketName}"
              uploadType: "media"
              name: "${metadataObjectName}"
              body: "${item}"
