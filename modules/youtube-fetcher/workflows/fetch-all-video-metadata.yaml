- CalculateCachedResponsePrefix:
    assign:
      - today: '${text.split(time.format(sys.now()), "T")[0]}'
      - cachedReponsePrefix: '${channelId + "/youtube-list-search-all/" + today}'
- CheckIfCachedSearchListExists:
    call: "googleapis.storage.v1.objects.list"
    args:
      bucket: "${cacheBucketName}"
      matchGlob: '${cachedReponsePrefix + "-*.json"}'
    result: "cachedResponseExists"
- DetermineIfRequestSearchList:
    switch:
      - condition: '${"items" in cachedResponseExists}'
        next: "GetAllSearchLists"
    next: "PrepareForIterateAllPages"
- PrepareForIterateAllPages:
    assign:
      - pageToken: ""
      - lastIndex: 0
- IterateForAllPages:
    for:
      value: "i"
      range: [0, 1]
      steps:
        - RequestSearchList:
            call: "http.get"
            args:
              url: "https://asia-east1-www-kaito-tokyo.cloudfunctions.net/youtube-list-search"
              query:
                channelId: "${channelId}"
                pageToken: "${pageToken}"
              auth:
                type: "OIDC"
            result: "requestedSearchList"
        - SaveSearchList:
            call: "googleapis.storage.v1.objects.insert"
            args:
              bucket: "${cacheBucketName}"
              uploadType: "media"
              name: '${cachedReponsePrefix + "-" + i + ".json"}'
              body: "${requestedSearchList}"
        - DetermineHasNextPage:
            switch:
              - condition: '${not ("nextPageToken" in requestedSearchList)}'
                next: "break"
            next: "SetNextPageToken"
        - SetNextPageTokenAndLastIndex:
            assign:
              - pageToken: "${requestedSearchList.nextPageToken}"
              - lastIndex: "${i}"
- GetAllSearchLists:
    call: "googleapis.storage.v1.objects.list"
    args:
      bucket: "${cacheBucketName}"
      matchGlob: '${cachedReponsePrefix + "-*.json"}'
    result: "cachedSearchLists"
- IterateForAllSearchLists:
    return: "${cachedSearchLists}"
