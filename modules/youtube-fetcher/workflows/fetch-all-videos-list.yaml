- ListAllSearchItems:
    call: "googleapis.storage.v1.objects.list"
    args:
      bucket: "${metadataBucketName}"
      matchGlob: '${channelId + "/search/*.json"}'
    result: "searchItems"
- AssignRequestVariables:
    assign:
      - itemsPerRequest: 50
      - sizeOfSearchItems: "${len(searchItems.items)}"
      - numRequest: "${int((sizeOfSearchItems + itemsPerRequest - 1) / itemsPerRequest)}"
- IterateForVideosRequests:
    for:
      value: pageIndex
      range: [0, "${numRequest - 1}"]
      steps:
        - AssignLoopVariablesForVideosRequests:
            assign:
              - requestingItems: []
              - startingItemIndex: "${pageIndex * itemsPerRequest}"
              - endingItemIndex: "${math.min(len(searchItems.items), (pageIndex + 1) * itemsPerRequest) - 1}"
        - LogIterateForVideosRequests:
            call: "sys.log"
            args:
              text: '${startingItemIndex + ":" + endingItemIndex}'
        - GenerateRequestingIds:
            for:
              value: itemIndex
              range: ["${startingItemIndex}", "${endingItemIndex}"]
              steps:
                - AppendSearchItem:
                    assign:
                      - videoId: '${text.split(text.split(searchItems.items[itemIndex].name, " ")[1], ".")[0]}'
                      - requestingItems: "${list.concat(requestingItems, videoId)}"
        - RequestVideosList:
            call: "http.post"
            args:
              url: "https://asia-east1-www-kaito-tokyo.cloudfunctions.net/youtube-list-videos"
              headers:
                "Content-Type": "application/x-www-form-urlencoded"
              body:
                id: "${requestingItems}"
            result: "videosList"
        - Return:
            return: "${videosList}"
