- CalculateCachedObjectName:
    assign:
      - today: '${text.split(time.format(sys.now()), "T")[0]}'
      - cachedObjectName: '${channelId + "/youtube-list-search/" + today + ".json"}'
- CheckIfCachedSearchListExists:
    call: googleapis.storage.v1.objects.list
    args:
      bucket: "${cacheBucketName}"
      matchGlob: "${cachedObjectName}"
    result: cachedResponseExists
- DetermineIfRequestSearchList:
    switch:
      - condition: '${"items" in cachedResponseExists}'
        next: "GetSearchList"
    next: "RequestSearchList"
- RequestSearchList:
    call: "http.get"
    args:
      url: "https://asia-east1-www-kaito-tokyo.cloudfunctions.net/youtube-list-search"
      query:
        channelId: "${channelId}"
      auth:
        type: "OIDC"
    result: "requestedSearchList"
- SaveSearchList:
    call: "googleapis.storage.v1.objects.insert"
    args:
      bucket: "${cacheBucketName}"
      uploadType: "media"
      name: "${cachedObjectName}"
      body: "${requestedSearchList}"
- GetSearchList:
    call: "googleapis.storage.v1.objects.get"
    args:
      bucket: "${cacheBucketName}"
      object: "${text.url_encode(cachedObjectName)}"
      alt: "media"
    result: "searchList"
- IterateForAllSearchItems:
    parallel:
      for:
        value: "item"
        in: "${searchList.body.items}"
        steps:
          - AssignMetadataObjectName:
              assign:
                - metadataObjectName: '${channelId + "/search/" + item.snippet.publishedAt + "-" + item.id.videoId + ".json"}'
          - SaveSearchItem:
              call: "googleapis.storage.v1.objects.insert"
              args:
                bucket: "${metadataBucketName}"
                uploadType: "media"
                name: "${metadataObjectName}"
                body: "${item}"
