name: "YouTube Fetcher"

on:
  workflow_call:
    inputs:
      infra-manager-service-account:
        required: true
        type: "string"
      function-service-account:
        required: true
        type: "string"
      region:
        required: true
        type: "string"
    secrets:
      project-id:
        required: true
      project-number:
        required: true
      wif-pool-id:
        required: true
      wif-provider-id:
        required: true
      wif-service-account:
        required: true

jobs:
  DeployYouTubeFetcherInfra:
    permissions:
      contents: "read"
      id-token: "write"
    uses: "./.github/workflows/deploy-infra-manager.yaml"
    with:
      name: "youtube-fetcher"
      infra-manager-service-account: "${{ inputs.infra-manager-service-account }}"
      region: "${{ inputs.region }}"
      input-values: "project_id=${{ secrets.project-id }}"
    secrets: "inherit"

  DeployYouTubeFetcherDigest:
    permissions:
      contents: "read"
      id-token: "write"
    needs:
      - "DeployYouTubeFetcherInfra"
    uses: "./.github/workflows/deploy-cloud-function.yaml"
    with:
      name: "youtube-fetcher-digest"
      working-directory: "serverless/youtube-fetcher"
      region: "${{ inputs.region }}"
      function-service-account: "${{ inputs.function-service-account }}"
    secrets: "inherit"

  DeployYouTubeFetcherListSearch:
    permissions:
      contents: "read"
      id-token: "write"
    needs:
      - "DeployYouTubeFetcherInfra"
    uses: "./.github/workflows/deploy-cloud-function.yaml"
    with:
      name: "youtube-fetcher-list-search"
      working-directory: "serverless/youtube-fetcher"
      region: "${{ inputs.region }}"
      function-service-account: "${{ inputs.function-service-account }}"
    secrets: "inherit"

  DeployYouTubeFetcherListVideos:
    permissions:
      contents: "read"
      id-token: "write"
    needs:
      - "DeployYouTubeFetcherInfra"
    uses: "./.github/workflows/deploy-cloud-function.yaml"
    with:
      name: "youtube-fetcher-list-videos"
      working-directory: "serverless/youtube-fetcher"
      region: "${{ inputs.region }}"
      function-service-account: "${{ inputs.function-service-account }}"
    secrets: "inherit"
